<script>
  // ==========================================================
  // CONST
  // ==========================================================
  const MONTHS = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

  const PATHS = {
    login: '/finfamily/Oria/assets/pages/login/login.html',
    income: '/finfamily/Oria/assets/pages/income/income.html',
    expenses: '/finfamily/Oria/assets/pages/expenses/expenses.html',
    cards: '/finfamily/Oria/assets/pages/cards/cards.html',
    piggy: '/finfamily/Oria/assets/pages/piggy/piggy.html',
    settings: '/finfamily/Oria/assets/pages/settings/settings.html'
  };

  let db = null;
  let user = null;
  let currentMonth = null;
  let initialized = false;

  // ==========================================================
  // HELPERS
  // ==========================================================
  function go(p){ window.location.href = p; }

  function brl(v){
    return Number(v || 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  }

  function nowYYYYMM(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  }

  function addMonthsSafe(yyyyMM, delta){
    if (!yyyyMM) return nowYYYYMM();
    const [y,m] = yyyyMM.split('-').map(Number);
    const d = new Date(y, (m-1)+delta, 1);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  }

  function renderMonthLabel(yyyyMM){
    if (!yyyyMM) return;
    const [y,m] = yyyyMM.split('-');
    document.getElementById('monthLabel').textContent =
      `${MONTHS[m-1]} de ${y}`;
  }

  // ==========================================================
  // SUPABASE RESOLVER (ROBUSTO)
  // ==========================================================
  function resolveSupabaseClient(){
    // tenta padrões comuns
    if (window.supabase && window.supabase.auth && window.supabase.from) return window.supabase;
    if (window.db && window.db.auth) return window.db;
    if (window.supabaseClient && window.supabaseClient.auth) return window.supabaseClient;
    if (window.client && window.client.auth) return window.client;
    return null;
  }

  async function waitForSupabase(){
    return new Promise((resolve, reject) => {
      const start = Date.now();
      const timer = setInterval(() => {
        const c = resolveSupabaseClient();
        if (c) {
          clearInterval(timer);
          resolve(c);
        }
        if (Date.now() - start > 4000) {
          clearInterval(timer);
          reject('Supabase não encontrado');
        }
      }, 50);
    });
  }

  // ==========================================================
  // DATA
  // ==========================================================
  async function loadUser(){
    const { data, error } = await db.auth.getUser();
    if (error || !data?.user) return null;
    return data.user;
  }

  async function resolveMonth(){
    const { data } = await db
      .from('user_settings')
      .select('current_month')
      .eq('user_id', user.id)
      .maybeSingle();

    if (!data || !data.current_month) {
      const m = nowYYYYMM();
      await db.from('user_settings').upsert({
        user_id: user.id,
        current_month: m
      });
      return m;
    }
    return data.current_month;
  }

  async function updateMonth(m){
    await db
      .from('user_settings')
      .update({ current_month: m })
      .eq('user_id', user.id);
  }

  async function sum(type, origin){
    let q = db
      .from('transactions')
      .select('amount, origin')
      .eq('user_id', user.id)
      .eq('month', currentMonth)
      .eq('type', type);

    if (origin === 'house') {
      q = q.or('origin.eq.house,origin.is.null');
    }

    const { data } = await q;
    return (data || []).reduce((s,r)=>s+Number(r.amount||0),0);
  }

  async function loadTotals(){
    const inc = await sum('income');
    const exp = await sum('expense','house');
    const bal = inc - exp;

    document.getElementById('incomeValue').textContent = brl(inc);
    document.getElementById('expenseValue').textContent = brl(exp);

    const b = document.getElementById('balanceValue');
    b.textContent = brl(bal);
    b.classList.remove('green','red');
    b.classList.add(bal >= 0 ? 'green' : 'red');
  }

  // ==========================================================
  // MONTH NAV
  // ==========================================================
  async function changeMonth(delta){
    if (!initialized) return;
    currentMonth = addMonthsSafe(currentMonth, delta);
    renderMonthLabel(currentMonth);
    await updateMonth(currentMonth);
    await loadTotals();
  }

  // ==========================================================
  // INIT
  // ==========================================================
  (async function init(){
    try {
      db = await waitForSupabase();
    } catch(e){
      console.error(e);
      return;
    }

    user = await loadUser();
    if (!user) return go(PATHS.login);

    // bind
    document.getElementById('btnProfile').onclick = () => go(PATHS.settings);
    document.getElementById('btnIncome').onclick = () => go(PATHS.income);
    document.getElementById('btnExpenses').onclick = () => go(PATHS.expenses);

    document.getElementById('goHouse').onclick = () => go(PATHS.expenses);
    document.getElementById('goIncome').onclick = () => go(PATHS.income);
    document.getElementById('goCards').onclick = () => go(PATHS.cards);
    document.getElementById('goPiggy').onclick = () => go(PATHS.piggy);

    document.getElementById('prevMonth').onclick = () => changeMonth(-1);
    document.getElementById('nextMonth').onclick = () => changeMonth(1);

    currentMonth = await resolveMonth();
    renderMonthLabel(currentMonth);
    await loadTotals();

    initialized = true;
  })();
</script>
