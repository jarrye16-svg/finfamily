// =============================================
// Oria • Home Script
// =============================================

// Aguarda o Supabase estar disponível
async function waitSupabaseReady() {
  while (!window.supabase) {
    await new Promise((resolve) => setTimeout(resolve, 100));
  }
}

// Função principal
document.addEventListener('DOMContentLoaded', async () => {
  console.log('[Oria] Página Home carregada');

  // Espera o Supabase
  await waitSupabaseReady();

  // Elementos principais
  const currentMonthEl = document.getElementById('currentMonth');
  const incomeValue = document.getElementById('incomeValue');
  const expenseValue = document.getElementById('expenseValue');
  const creditValue = document.getElementById('creditValue');
  const balanceValue = document.getElementById('balanceValue');

  // ===========================
  // Controle de Mês
  // ===========================
  const monthNames = [
    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
  ];

  let currentDate = new Date();

  function renderMonth() {
    if (!currentMonthEl) return console.warn('[Oria] #currentMonth não encontrado.');

    const monthName = monthNames[currentDate.getMonth()];
    const year = currentDate.getFullYear();
    currentMonthEl.innerText = `${monthName} de ${year}`;
  }

  // Botões de navegação do mês
  const btnPrev = document.getElementById('prevMonth');
  const btnNext = document.getElementById('nextMonth');

  if (btnPrev) {
    btnPrev.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderMonth();
      loadSummary();
    });
  }

  if (btnNext) {
    btnNext.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderMonth();
      loadSummary();
    });
  }

  renderMonth(); // exibe o mês atual logo ao carregar

  // ===========================
  // Carregar dados do usuário
  // ===========================
  async function loadSummary() {
    try {
      const { data: { user } } = await window.supabase.auth.getUser();
      if (!user) {
        console.warn('[Oria] Nenhum usuário logado. Redirecionando...');
        window.location.href = '/finfamily/Oria/assets/pages/login/login.html';
        return;
      }

      console.log('[Oria] Usuário logado:', user.email);

      // Aqui você pode buscar dados reais do Supabase:
      // const { data, error } = await window.supabase
      //   .from('transactions')
      //   .select('*')
      //   .eq('user_id', user.id);

      // Exemplo estático (placeholder):
      if (incomeValue) incomeValue.innerText = 'R$ 0,00';
      if (expenseValue) expenseValue.innerText = 'R$ 0,00';
      if (creditValue) creditValue.innerText = 'R$ 0,00';
      if (balanceValue) balanceValue.innerText = 'R$ 0,00';
    } catch (err) {
      console.error('[Oria] Erro ao carregar resumo:', err);
    }
  }

  await loadSummary();

  // ===========================
  // Atalhos
  // ===========================
  const btnExpenses = document.getElementById('btnExpenses');
  const btnIncome = document.getElementById('btnIncome');
  const btnPiggy = document.getElementById('btnPiggy');
  const btnCards = document.getElementById('btnCards');

  if (btnExpenses) {
    btnExpenses.addEventListener('click', () => {
      window.location.href = '/finfamily/Oria/assets/pages/app/expenses/expenses.html';
    });
  }

  if (btnIncome) {
    btnIncome.addEventListener('click', () => {
      window.location.href = '/finfamily/Oria/assets/pages/app/income/income.html';
    });
  }

  if (btnPiggy) {
    btnPiggy.addEventListener('click', () => {
      window.location.href = '/finfamily/Oria/assets/pages/app/piggy/piggy.html';
    });
  }

  if (btnCards) {
    btnCards.addEventListener('click', () => {
      window.location.href = '/finfamily/Oria/assets/pages/app/cards/cards.html';
    });
  }
});
