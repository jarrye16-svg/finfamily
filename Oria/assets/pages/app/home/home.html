<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Oria â€¢ Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonte -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/finfamily/Oria/assets/core/supabase.js"></script>

  <style>
    :root{
      --bg1:#f6f9ff;
      --bg2:#eef3ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --blue1:#2563eb;
      --blue2:#4f7cff;
      --green:#16a34a;
      --red:#dc2626;
      --shadow: 0 14px 36px rgba(15, 23, 42, 0.10);
      --shadowSoft: 0 10px 28px rgba(15, 23, 42, 0.08);
      --radius: 22px;
    }

    *{ box-sizing:border-box; font-family:'Inter', sans-serif; }
    body{
      margin:0;
      min-height:100vh;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--text);
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding:26px 18px 90px;
    }

    /* TOP */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logoBox{
      width:44px;height:44px;
      border-radius:14px;
      background:#fff;
      box-shadow:var(--shadowSoft);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .logoBox img{ width:26px;height:26px; }
    .logoFallback{
      display:none;
      width:26px;height:26px;
      border-radius:8px;
      background:var(--blue1);
      color:#fff;
      font-weight:800;
      align-items:center;
      justify-content:center;
      font-size:14px;
    }
    .titles .appName{
      font-size:18px;
      font-weight:700;
      margin:0;
    }
    .titles .subtitle{
      font-size:13px;
      color:var(--muted);
    }
    .profileBtn{
      width:44px;height:44px;
      border-radius:14px;
      border:none;
      background:#fff;
      box-shadow:var(--shadowSoft);
      cursor:pointer;
      font-size:18px;
    }

    /* MONTH */
    .monthBox{
      background:#fff;
      border-radius:24px;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:var(--shadow);
      margin-bottom:20px;
    }
    .monthBtn{
      width:44px;height:44px;
      border-radius:999px;
      border:none;
      background:#eef4ff;
      font-size:22px;
      font-weight:800;
      cursor:pointer;
    }
    .monthCenter{
      text-align:center;
      flex:1;
    }
    .monthLabel{
      font-size:20px;
      font-weight:800;
    }
    .monthHint{
      font-size:12px;
      color:var(--muted);
    }

    /* CARDS */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:14px;
    }
    @media(min-width:900px){
      .grid{ grid-template-columns:repeat(3,1fr); }
    }
    .card{
      background:#fff;
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
      cursor:pointer;
    }
    .card.info{ cursor:default; }
    .cardLabel{
      font-size:13px;
      color:var(--muted);
      font-weight:600;
    }
    .cardValue{
      font-size:26px;
      font-weight:800;
      margin-top:6px;
    }
    .green{ color:var(--green); }
    .red{ color:var(--red); }

    /* ACTIONS */
    .actions{ margin-top:26px; }
    .actionsTitle{
      font-size:16px;
      font-weight:800;
      margin-bottom:12px;
    }
    .actionsGrid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
    }
    @media(min-width:900px){
      .actionsGrid{ grid-template-columns:repeat(4,1fr); }
    }
    .actionBtn{
      border:none;
      border-radius:20px;
      padding:16px;
      background:#fff;
      box-shadow:var(--shadowSoft);
      font-weight:800;
      cursor:pointer;
    }
    .actionBtn.primary{
      background:linear-gradient(135deg,var(--blue1),var(--blue2));
      color:#fff;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- TOP -->
  <div class="topbar">
    <div class="brand">
      <div class="logoBox">
        <img src="/finfamily/Oria/assets/branding/logo/oria-icon.png"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div class="logoFallback">O</div>
      </div>
      <div class="titles">
        <p class="appName">Oria</p>
        <div class="subtitle">VisÃ£o geral</div>
      </div>
    </div>
    <button class="profileBtn" onclick="go('/finfamily/Oria/assets/pages/settings/settings.html')">ðŸ‘¤</button>
  </div>

  <!-- MONTH -->
  <div class="monthBox">
    <button class="monthBtn" onclick="changeMonth(-1)">â€¹</button>
    <div class="monthCenter">
      <div class="monthLabel" id="monthLabel">â€”</div>
      <div class="monthHint">Troque o mÃªs para ver seus dados</div>
    </div>
    <button class="monthBtn" onclick="changeMonth(1)">â€º</button>
  </div>

  <!-- SUMMARY -->
  <div class="grid">
    <div class="card" onclick="go('/finfamily/Oria/assets/pages/income/income.html')">
      <div class="cardLabel">Entradas do mÃªs</div>
      <div class="cardValue green" id="incomeValue">R$ 0,00</div>
    </div>

    <div class="card" onclick="go('/finfamily/Oria/assets/pages/expenses/expenses.html')">
      <div class="cardLabel">Gastos do mÃªs</div>
      <div class="cardValue red" id="expenseValue">R$ 0,00</div>
    </div>

    <div class="card info">
      <div class="cardLabel">Saldo do mÃªs</div>
      <div class="cardValue" id="balanceValue">R$ 0,00</div>
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="actions">
    <div class="actionsTitle">AÃ§Ãµes rÃ¡pidas</div>
    <div class="actionsGrid">
      <button class="actionBtn primary" onclick="go('/finfamily/Oria/assets/pages/expenses/expenses.html')">Contas da casa</button>
      <button class="actionBtn" onclick="go('/finfamily/Oria/assets/pages/income/income.html')">Entradas</button>
      <button class="actionBtn" onclick="go('/finfamily/Oria/assets/pages/cards/cards.html')">CartÃµes</button>
      <button class="actionBtn" onclick="go('/finfamily/Oria/assets/pages/piggy/piggy.html')">Porquinho</button>
    </div>
  </div>

</div>

<script>
  const MONTHS = ['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  let db, user, currentMonth;

  function go(p){ window.location.href = p; }

  function ymLabel(ym){
    const [y,m]=ym.split('-');
    return `${MONTHS[m-1]} de ${y}`;
  }

  function addMonths(ym,d){
    const [y,m]=ym.split('-').map(Number);
    const dt=new Date(y,m-1+d,1);
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
  }

  function brl(v){
    return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  }

  async function loadMonth(){
    const { data } = await db.from('user_settings')
      .select('current_month')
      .eq('user_id',user.id)
      .maybeSingle();

    if(!data){
      currentMonth = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
      await db.from('user_settings').insert([{ user_id:user.id, current_month }]);
    }else{
      currentMonth = data.current_month;
    }
    document.getElementById('monthLabel').textContent = ymLabel(currentMonth);
    loadTotals();
  }

  async function changeMonth(d){
    currentMonth = addMonths(currentMonth,d);
    await db.from('user_settings').update({ current_month }).eq('user_id',user.id);
    document.getElementById('monthLabel').textContent = ymLabel(currentMonth);
    loadTotals();
  }

  async function loadTotals(){
    let inc=0, exp=0;
    try{
      const r1 = await db.from('transactions').select('amount').eq('user_id',user.id).eq('month',currentMonth).eq('type','income');
      r1.data?.forEach(i=>inc+=Number(i.amount));
      const r2 = await db.from('transactions').select('amount').eq('user_id',user.id).eq('month',currentMonth).eq('type','expense').or('origin.eq.house,origin.is.null');
      r2.data?.forEach(i=>exp+=Number(i.amount));
    }catch(e){}
    document.getElementById('incomeValue').textContent = brl(inc);
    document.getElementById('expenseValue').textContent = brl(exp);
    const bal = inc-exp;
    const el = document.getElementById('balanceValue');
    el.textContent = brl(bal);
    el.className = 'cardValue ' + (bal>=0?'green':'red');
  }

  (async()=>{
    db = window.supabase;
    const res = await db.auth.getUser();
    user = res.data.user;
    if(!user) return go('/finfamily/Oria/assets/pages/login/login.html');
    loadMonth();
  })();
</script>
</body>
</html>
